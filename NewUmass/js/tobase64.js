layui.define(function (a) { var b = layui.$, c = { config: {} }, d = function (a) { var d = this; d.config = b.extend({}, c.config, a), console.log(d.config), b(d.config.elem).each(function (a) { b(this).after('<input type="file" id="tobase64' + a + '" name="tobase64' + a + '" class="layui-hide change-tobase64" />') }), b(document).on("click", d.config.elem, function () { var a = b(d.config.elem).index(this); b("#tobase64" + a).click() }), b(document).on("change", ".change-tobase64", function () { var g, h, i, c = b(this).val(), e = c.substr(c.lastIndexOf("."), 4); e = e.toLowerCase(), d.config.btype = e, ".jpg" == e || ".png" == e || ".gif" == e ? (g = this.files[0], h = window.URL || window.webkitURL, i = h.createObjectURL(g), b.isFunction(a.before) && a.before(this, i, g), f(i, g)) : d.config.errot("图片类型不正确"), b(this).val("") }) }, e = function (a) { var b = "image/jpg"; return ".png" == a ? b = "image/png" : ".gif" == a && (b = "image/gif"), b }, f = function (a) { var d, c = new Image; c.src = a, d = this, c.onload = function () { var h, i, j, k, l, m, a = this, f = c.width, g = c.height; f > d.config.width && (f = a.width, g = a.height, scale = f / g, f = d.config.width || f, g = f / scale), h = document.createElement("canvas"), i = h.getContext("2d"), b(h).attr({ width: f, height: g }), i.drawImage(a, 0, 0, f, g), j = h.toDataURL(e(d.config.btype), d.config.quality || .8), navigator.userAgent.match(/iphone/i) && (k = new MegaPixImage(c), k.render(h, { maxWidth: f, maxHeight: g, quality: d.config.quality || .8 }), j = h.toDataURL(e(d.config.btype), d.config.quality || .8)), navigator.userAgent.match(/Android/i) && (l = new JPEGEncoder, j = l.encode(i.getImageData(0, 0, f, g), 100 * d.config.quality || 80)), m = { base64: j, clearBase64: j.substr(j.indexOf(",") + 1) }, d.config.success(m, d.config.btype) } }; c.render = function (a) { return d(a) }, a("tobase64", c) });